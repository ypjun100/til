# 제한 컬렉션과 TTL 인덱스

### 제한 컬렉션

* 컬렉션은 추가 데이터에 맞춰 크기가 자동으로 늘어나지만, 제한 컬렉션은 미리 생성돼 크기가 고정된 형태임
* 만약 가득 찬 컬렉션에 입력을 시도하면 가장 오래된 도큐먼트가 지워지고 남은 자리를 새 도큐먼트가 차지함
* 제한 컬렉션에서 임의의 도큐먼트는 삭제될 수 없으며, 도큐먼트 크기가 커지는 갱신도 허용되지 않음
* 도큐먼트의 삭제 및 갱신을 제한함으로써 순서를 보장하고, 삭제로 인한 가용 공간을 관리할 필요가 없음
* 일반적으로 몽고DB TTL 인덱스는 스토리지 엔진에서 더 나은 성능을 발휘하므로 제한 컬렉션보다 권장됨

```js
> db.createCollection("my_collection", { "capped": true, "size": 100000 })
```

* 제한 컬렉션은 사용되기 전에 명시적으로 생성되어야 하며, `createCollection`을 사용해 생성 가능함
* 위의 코드로는 10만 바이트 고정 크기로 제한 컬렉션 `my_collection`을 생성함

### TTL 인덱스

```js
> // 24시간 뒤 타임아웃
> db.sessions.createIndex(
... { "lastUpdated": 1 },
... { "expireAfterSeconds": 60 * 60 * 24 })
```

* 오래된 순으로 삭제하는 시스템을 위해 TTL 인덱스를 이용해 도큐먼트의 유효 시간을 설정할 수 있음
* 도큐먼트는 미리 설정한 시간에 도달하면 지워지며, 세션 스토리지와 같은 목적으로 캐싱하는 데 유용함
* 위와 같이 `createIndex`의 두 번째 인자에 `expireAfterSeconds` 옵션을 명시해 인덱스를 생성함
	* `lastUpdated` 필드가 존재하고 날짜형인 경우, 해당 필드를 기준으로 설정한 시간 이후에 삭제함
	* 따라서, 세션이 삭제되는 것을 방지하려면, 세션 활동이 있을 때마다 직접 해당 필드를 업데이트해야 함
* 몽고DB는 TTL 인덱스를 매분마다 청소하므로 초 단위로 신경 쓸 필요는 없음