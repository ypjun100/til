# 복제

* 단일 서버로 DB를 구성한다면 서버가 고장나 이용 불가능한 상태가 되어 DB를 제대로 사용할 수 없음
* 복제는 데이터의 동일한 복사본을 여러 서버상에 보관하는 방법이며, 실제 서비스를 배포할 때 권장됨
* 한 대 또는 그 이상의 서버에 이상이 발생해도, 정상적으로 동작하게 하고 데이터를 안전하게 보존함
* 몽고DB는 복제 셋을 생성하여 설정할 수 있으며, 프라이머리 한 대와 세컨더리 서버 여러 대로 구성됨
	* 프라이머리는 클라이언트 요청을 처리하며, 세컨더리 서버는 프라이머리 데이터의 복사본을 가짐
	* 프라이머리 서버에 장애가 발생하면 세컨더리 서버들 중 하나를 프라이머리 서버로 선출함

### 복제 셋 설정

* 운영 환경에서는 항상 복제 셋을 사용하며, 각 멤버(프라이머리, 세컨더리 등)를 별도의 서버에 배치해야 함
* 물리적으로 분리된 서버에 각각 멤버를 지정함으로써, 프로세스의 충돌 즉, 리소스 경합을 방지할 수 있음
	* 리소스 경합이란 여러 프로세스 및 서비스가 제한된 자원을 동시에 사용하려고 할 때 발생하는 충돌임
* 추가적인 복원력을 제공하려면 DNS Seedlist 연결 방식을 사용해 앱이 복제 셋에 연결하는 방법을 지정함
	* DNS Seedlist는 클라이언트가 복제 셋의 멤버 목록을 DNS를 통해 동적으로 받을 수 있는 기술임
	* 몽고DB 3.6 버전부터 지원되며, 연결 문자열에 'mongodb+srv://' 접두사를 사용함

```bash
$ mongod --replSet mdbDefGuide --dbpath ~/data/rs1 --port 27017 --oplogSize 200
$ mongod --replSet mdbDefGuide --dbpath ~/data/rs2 --port 27018 --oplogSize 200
$ mongod --replSet mdbDefGuide --dbpath ~/data/rs3 --port 27019 --oplogSize 200
```

* 위의 명령으로 총 3개의 복제 셋을 생성할 수 있으며, 정상적인 경우 별도의 mongod 프로세스가 실행됨
* 하지만 mongod가 다른 프로세스의 존재를 알진 못하므로 구성을 만들어 프로세스 중 하나로 보내야 함
	* 구성을 전달받은 프로세스는 이를 다른 멤버(mongod 프로세스)에 전파하여 복제 셋을 구성함

```bash
$ mongo --port 27017
> rsconf = {
> 	_id: "mdbDefGuide",
> 	members: [
> 		{_id: 0, host: "locahost:27017"},
> 		{_id: 1, host: "locahost:27018"},
> 		{_id: 2, host: "locahost:27019"}
> 	]
> }
> rs.initiate(rsconf)
```

* `mongo` 명령으로 특정 포트(27017)에서 실행 중인 mongod 인스턴스에 연결하여 셸을 시작할 수 있음
* 구성 도큐먼트를 만들고 `initiate()`에 전달하면, 구성을 나머지 mongod에 전파해 복제 셋이 형성됨
	* 도큐먼트의 `_id`는 복제 셋의 이름으로, 각 노드는 mongod 프로세스를 시작할 때 동일하게 설정함
	* `members`는 셋 멤버의 배열로, 각 맴버에는 `_id`, `host`가 필요하며 멤버 간에 고유해야 함

> 독립 실행형 몽고DB 서버(복제 셋으로 구성되지 않은 서버)는 다운 타임 없이 복제 셋 환경으로 변경할 수 없으며, 무조건 서버를 반드시 복제 셋 모드로 재시작해야지 복제 셋 구성으로 동작할 수 있다.